<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galeri</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fff0f5;
      text-align: center;
      padding: 20px;
    }
    input, textarea, button {
      margin: 10px;
      padding: 8px;
      font-size: 1em;
    }
    #gallery div {
      display: inline-block;
      margin: 10px;
      background: #ffeef8;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    img {
      width: 200px;
      border-radius: 8px;
    }
    .control-btns button {
      margin: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 6px;
      background-color: #ff69b4;
      color: white;
      cursor: pointer;
    }
    .control-btns button:hover {
      background-color: #ff1493;
    }
  </style>
</head>
<body>
  <h1>Galeri</h1>
  <p>Upload foto-foto</p>

  <input type="file" id="imageInput" /> <br />
  <input type="text" id="descriptionInput" placeholder="Deskripsi..." /> <br />
  <input type="date" id="dateInput" /> <br />
  <button onclick="uploadImage()">Upload</button>

  <h2>Galeri</h2>
  <div id="gallery"></div>

  <script>
    const SUPABASE_URL = 'https://yloxsoekekxpcypygufc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsb3hzb2VrZWt4cGN5cHlndWZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2MjY0NDYsImV4cCI6MjA2MzIwMjQ0Nn0.Xwc-tXxSDiJP14h-yz0cFwcf_PVZNraDiIgCZ8p4qs8';
    const IMGUR_CLIENT_ID = '3f14502cc5b7e8e';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function uploadImage() {
      const file = document.getElementById('imageInput').files[0];
      const description = document.getElementById('descriptionInput').value;
      const date = document.getElementById('dateInput').value;

      if (!file) return alert("Pilih gambar dulu yaa");

      const formData = new FormData();
      formData.append("image", file);

      const imgurRes = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
        },
        body: formData,
      });

      const imgurData = await imgurRes.json();
      const imgurLink = imgurData.data.link;

      const { data, error } = await supabaseClient.from("images").insert([
        { link: imgurLink, description: description, date: date },
      ]);

      if (error) {
        alert("Gagal simpan ke galeri ðŸ˜¢");
        console.error(error);
      } else {
        document.getElementById('imageInput').value = "";
        document.getElementById('descriptionInput').value = "";
        document.getElementById('dateInput').value = "";
        loadGallery();
      }
    }

    async function loadGallery() {
      const { data, error } = await supabaseClient
        .from("images")
        .select("*")
        .order("created_at", { ascending: false });

      const container = document.getElementById("gallery");
      container.innerHTML = "";

      data.forEach((item) => {
        const wrapper = document.createElement("div");

        const img = document.createElement("img");
        img.src = item.link;
        img.alt = item.description || "";

        const caption = document.createElement("p");
        caption.textContent = `${item.description || ''} (${item.date || ''})`;

        const controlBtns = document.createElement("div");
        controlBtns.className = "control-btns";

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Hapus";
        deleteBtn.onclick = async () => {
          if (confirm("Yakin mau hapus foto ini?")) {
            await supabaseClient.from("images").delete().eq("id", item.id);
            loadGallery();
          }
        };

        const editBtn = document.createElement("button");
        editBtn.textContent = "Ubah Deskripsi";
        editBtn.onclick = async () => {
          const newDesc = prompt("Deskripsi baru:", item.description || "");
          if (newDesc !== null) {
            await supabaseClient.from("images").update({ description: newDesc }).eq("id", item.id);
            loadGallery();
          }
        };

        controlBtns.appendChild(editBtn);
        controlBtns.appendChild(deleteBtn);

        wrapper.appendChild(img);
        wrapper.appendChild(caption);
        wrapper.appendChild(controlBtns);
        container.appendChild(wrapper);
      });
    }

    document.addEventListener("DOMContentLoaded", loadGallery);
  </script>
</body>
</html>
